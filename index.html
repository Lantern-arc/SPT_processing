<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –°–ü–¢ 2024</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; position: relative; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; box-shadow: 0 3px 10px rgba(0,0,0,.06); margin-bottom: 16px; }
    label { display:block; margin-bottom: 8px; font-weight: 600; }
    input[type=file] { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; max-width: 420px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; margin-right: 8px; }
    button.primary { background: #111827; color: white; }
    button.secondary { background: #f3f4f6; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .muted { color: #6b7280; font-size: 12px; }
    table { border-collapse: collapse; width: 100%; overflow: auto; }
    th, td { border: 1px solid #e5e7eb; padding: 6px 8px; font-size: 12px; text-align: left; vertical-align: top; }
    th { background: #f9fafb; position: sticky; top: 0; }
    #previewWrap { max-height: 420px; overflow: auto; border: 1px solid #eee; border-radius: 12px; }
    footer { font-size: 11px; color: #6b7280; text-align: center; margin-top: 40px; border-top: 1px solid #e5e7eb; padding-top: 10px; }
  </style>

  <!-- SheetJS -->
  <script src="./libs/xlsx.full.min.js"></script>
</head>

<body>
  <h1>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –°–ü–¢ 2024</h1>
  <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª (.xlsx, .xls, .csv).</p>

  <!-- üîπ –ß–µ–∫–±–æ–∫—Å —Å –∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–æ–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ -->
  <div class="card" style="margin-bottom:20px;">
    <label style="display:flex;align-items:center;gap:8px;margin:0;">
      <input type="checkbox" id="addInterpToggle" checked />
      –î–æ–±–∞–≤–ª—è—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –≤ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
    </label>
    <p class="muted" id="interpStatus">–ü–æ–∏—Å–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π‚Ä¶</p>
  </div>

  <!-- üîπ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è -->
  <div class="card">
    <p><strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–∞–±–ª–∏—Ü–µ:</strong></p>
    <ul>
      <li>–ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî —à–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã.</li>
      <li>–°—Ç–æ–ª–±–µ—Ü A ‚Äî –ì—Ä—É–ø–ø–∞/–∫–ª–∞—Å—Å</li>
      <li>–°—Ç–æ–ª–±–µ—Ü B ‚Äî –§–ò–û/–ú–≠–®-ID</li>
      <li>–°—Ç–æ–ª–±—Ü—ã C, D, E ‚Äî –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞ (—Å—É–º–º–∞), –§–∞–∫—Ç–æ—Ä—ã –∑–∞—â–∏—Ç—ã (—Å—É–º–º–∞), –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —à–∫–∞–ª–∞</li>
      <li>–°—Ç–æ–ª–±–µ—Ü F ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç (–ù–æ—Ä–º–∞, –í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–∞, –ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–∞)</li>
      <li>–°—Ç–æ–ª–±—Ü—ã G‚ÄìV ‚Äî –ó–Ω–∞—á–µ–Ω–∏—è —à–∫–∞–ª –≤ —Å—Ç–µ–Ω–∞—Ö</li>
    </ul>
  </div>

  <!-- üîπ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
  <div class="card">
    <label for="file">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:</label>
    <div class="row">
      <input id="file" type="file" accept=".xlsx,.xls,.csv" />
      <button class="primary" id="processBtn" disabled>–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
      <button class="secondary" id="downloadBtn" disabled>–°–∫–∞—á–∞—Ç—å XLSX</button>
    </div>
    <p class="muted" id="status">–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
  </div>

  <!-- üîπ –ü—Ä–µ–≤—å—é -->
  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px;">–ü—Ä–µ–≤—å—é (–ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏)</h2>
    <div id="previewWrap"><table id="previewTable"></table></div>
  </div>

  <footer>
    by LanternARC. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –î–∞–Ω–Ω—ã–π —Å–∞–π—Ç –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö.
  </footer>

  <script>
    let originalAOA = null;
    let workbookOut = null;
    let interpretationMap = {}; 

    const fileEl = document.getElementById('file');
    const addInterpToggle = document.getElementById('addInterpToggle');
    const processBtn = document.getElementById('processBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const statusEl = document.getElementById('status');
    const previewTable = document.getElementById('previewTable');
    const interpStatus = document.getElementById('interpStatus');

    document.addEventListener('DOMContentLoaded', () => autoLoadInterpretations());

    async function autoLoadInterpretations() {
      async function tryFetch(url, type) {
        try {
          const resp = await fetch(url, { cache: 'no-store' });
          if (!resp.ok) return null;
          return type === 'arrayBuffer' ? await resp.arrayBuffer() : await resp.text();
        } catch (_) { return null; }
      }

      const candidatesXlsx = [
        'SPT_interpretations.xlsx',
        './SPT_interpretations.xlsx'
      ];
      for (const path of candidatesXlsx) {
        const buf = await tryFetch(path, 'arrayBuffer');
        if (buf) {
          const wb = XLSX.read(buf, { type: 'array', raw: true });
          interpretationMap = parseInterpretationWorkbook(wb);
          interpStatus.textContent = `–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω (XLSX): ${Object.keys(interpretationMap).length} —à–∫–∞–ª(—ã)`;
          return;
        }
      }

      const candidatesCsv = [
        'SPT_interpretations.csv',
        './SPT_interpretations.csv'
      ];
      for (const path of candidatesCsv) {
        const text = await tryFetch(path, 'text');
        if (text) {
          const wb = XLSX.read(text, { type: 'string' });
          interpretationMap = parseInterpretationWorkbook(wb);
          interpStatus.textContent = `–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω (CSV): ${Object.keys(interpretationMap).length} —à–∫–∞–ª(—ã)`;
          return;
        }
      }

      if (location.protocol === 'file:') {
        interpStatus.textContent = '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (http://), –∞ –Ω–µ file://';
      } else {
        interpStatus.textContent = '–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω (–æ–∂–∏–¥–∞–µ—Ç—Å—è SPT_interpretations.xlsx –∏–ª–∏ .csv —Ä—è–¥–æ–º —Å index.html).';
      }
    }

    function parseInterpretationWorkbook(wb) {
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rowsObj = XLSX.utils.sheet_to_json(ws, { defval: '' });
      const map = {};
      for (const row of rowsObj) {
        const name = String(row['–®–∫–∞–ª–∞'] ?? row['—à–∫–∞–ª–∞'] ?? '').trim();
        if (!name) continue;
        const low = String(row['–ù–∏–∑–∫–∏–π'] ?? row['–Ω–∏–∑–∫–∏–π'] ?? '').trim();
        const mid = String(row['–°—Ä–µ–¥–Ω–∏–π'] ?? row['—Å—Ä–µ–¥–Ω–∏–π'] ?? '').trim();
        const high = String(row['–í—ã—Å–æ–∫–∏–π'] ?? row['–≤—ã—Å–æ–∫–∏–π'] ?? '').trim();
        map[name] = { –Ω–∏–∑–∫–∏–π: low, —Å—Ä–µ–¥–Ω–∏–π: mid, –≤—ã—Å–æ–∫–∏–π: high };
      }
      return map;
    }

    fileEl.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      statusEl.textContent = '–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...';
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      originalAOA = aoa;
      if (!aoa.length) {
        statusEl.textContent = '–õ–∏—Å—Ç –ø—É—Å—Ç–æ–π';
        processBtn.disabled = true;
        return;
      }
      statusEl.textContent = '–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ.';
      processBtn.disabled = false;
      downloadBtn.disabled = true;
      previewTable.innerHTML = '';
    });

    processBtn.addEventListener('click', () => {
      if (!originalAOA) return;

      // === 1. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ===
      let aoa = originalAOA.map(r => r.slice(0, 22).concat(new Array(Math.max(0, 22 - r.length)).fill('')));
      const header = aoa[0];
      const rows = aoa.slice(1);
      const orderMap = new Map([['–ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–∞', 0], ['–í—ã—Å–æ–∫–∞—è –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ä–∏—Å–∫–∞', 1], ['–ù–æ—Ä–º–∞', 2]]);
      const cmp = (x,y)=>String(x).localeCompare(String(y),'ru',{numeric:true,sensitivity:'base'});
      rows.sort((a,b)=>{
        const fa = orderMap.get(a[5]) ?? 99, fb = orderMap.get(b[5]) ?? 99;
        if (fa!==fb) return fa-fb;
        const ca = cmp(a[0],b[0]); if (ca!==0) return ca;
        return cmp(a[1],b[1]);
      });
      aoa = [header].concat(rows);

      // === 2. –î–æ–±–∞–≤–ª—è–µ–º 16 –Ω–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ ===
      const newCatHeaders = [
        '–ü–ü–ó –∑–Ω–∞—á–µ–Ω–∏–µ','–ü–í–ì –∑–Ω–∞—á–µ–Ω–∏–µ','–ü–ê–£ –∑–Ω–∞—á–µ–Ω–∏–µ','–°–† –∑–Ω–∞—á–µ–Ω–∏–µ','–ò–ú –∑–Ω–∞—á–µ–Ω–∏–µ','–¢–† –∑–Ω–∞—á–µ–Ω–∏–µ',
        '–§–† –∑–Ω–∞—á–µ–Ω–∏–µ','–î–ï –∑–Ω–∞—á–µ–Ω–∏–µ','–ü–† –∑–Ω–∞—á–µ–Ω–∏–µ','–ü–û –∑–Ω–∞—á–µ–Ω–∏–µ','–°–ê –∑–Ω–∞—á–µ–Ω–∏–µ','–°–ü –∑–Ω–∞—á–µ–Ω–∏–µ',
        '–°–≠ –∑–Ω–∞—á–µ–Ω–∏–µ','–ê–ù –∑–Ω–∞—á–µ–Ω–∏–µ','–§–£ –∑–Ω–∞—á–µ–Ω–∏–µ','–î–û –∑–Ω–∞—á–µ–Ω–∏–µ'
      ];
      for (let c = 21; c >= 6; c--) {
        for (let r = 0; r < aoa.length; r++) aoa[r].splice(c+1,0,'');
        const k = c - 6;
        aoa[0][c+1] = newCatHeaders[k] || '–∑–Ω–∞—á–µ–Ω–∏–µ';
        for (let r = 1; r < aoa.length; r++) {
          const left = aoa[r][c];
          let cat = '';
          if (left === '-') cat = '-';
          else {
            const x = Number(left);
            if (isFinite(x)) {
              if (x <= 3) cat = '–ù–∏–∑–∫–∏–π';
              else if (x <= 7) cat = '–°—Ä–µ–¥–Ω–∏–π';
              else cat = '–í—ã—Å–æ–∫–∏–π';
            }
          }
          aoa[r][c+1] = cat;
        }
      }

      // === 3. –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã ===
      const scales = [
        '–ü–ª–æ—Ö–∞—è –ø—Ä–∏—Å–ø–æ—Å–æ–±–ª., –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å','–ü–æ—Ç—Ä–µ–±–Ω. –≤–æ –≤–Ω–∏–º–∞–Ω–∏–∏ –≥—Ä—É–ø–ø—ã','–ü—Ä–∏–Ω—è—Ç–∏–µ –∞—Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫',
        '–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ —Ä–∏—Å–∫—É','–ò–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å','–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å','–§—Ä—É—Å—Ç—Ä–∞—Ü–∏—è','–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –¥–µ–ª–∏–∫–≤–µ–Ω—Ç–Ω–æ—Å—Ç–∏',
        '–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏','–ü—Ä–∏–Ω—è—Ç–∏–µ –æ–¥–Ω–æ–∫–ª–∞—Å—Å–Ω–∏–∫–∞–º–∏','–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å','–°–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–≤–µ–¥–µ–Ω–∏—è',
        '–°–∞–º–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å','–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∫ –Ω–æ—Ä–º–∞–º','–§—Ä—É—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å','–î—Ä—É–∂–µ–ª—é–±–∏–µ, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å'
      ];

      const addInterpretations = !!addInterpToggle.checked;
      const reports = [];

      for (let r=1;r<aoa.length;r++){
        const row=aoa[r];
        if(row[5]==='–ì—Ä—É–ø–ø–∞ —Ä–∏—Å–∫–∞'){
          const klass=row[0]??'';
          const fio=row[1]??'';
          reports.push([klass?`${fio} ‚Äî ${klass}`:`${fio}`]);
          reports.push(addInterpretations ? ['–®–∫–∞–ª–∞','–°—Ç–µ–Ω','–ó–Ω–∞—á–µ–Ω–∏–µ','–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è'] : ['–®–∫–∞–ª–∞','–°—Ç–µ–Ω','–ó–Ω–∞—á–µ–Ω–∏–µ']);

          for(let k=0;k<16;k++){
            const scaleName = scales[k];
            const sten = row[6+k*2];

            let level = '';
            if (sten==='-') level='-';
            else {
              const x=Number(sten);
              if (isFinite(x)) {
                if (x<=3) level='–ù–∏–∑–∫–∏–π';
                else if (x<=7) level='–°—Ä–µ–¥–Ω–∏–π';
                else level='–í—ã—Å–æ–∫–∏–π';
              }
            }

            let interpText = '';
            if (addInterpretations) {
              if (level === '-') interpText = '-';
              else if (interpretationMap[scaleName]) {
                interpText = interpretationMap[scaleName][level.toLowerCase()] || '';
              }
            }

            if (addInterpretations) reports.push([scaleName, sten, level, interpText]);
            else reports.push([scaleName, sten, level]);
          }
          reports.push(['']);reports.push(['']);
        }
      }

      // === 4. –°–±–æ—Ä–∫–∞ ===
      const ws1=XLSX.utils.aoa_to_sheet(aoa);
      const ws2=XLSX.utils.aoa_to_sheet(reports.length?reports:[['–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä—É–ø–ø—ã —Ä–∏—Å–∫–∞']]);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws1,'–†–µ–∑—É–ª—å—Ç–∞—Ç');
      XLSX.utils.book_append_sheet(wb,ws2,'–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã');
      workbookOut=wb;

      const html=XLSX.utils.sheet_to_html(ws1);
      previewTable.innerHTML=html;
      statusEl.textContent='–ì–æ—Ç–æ–≤–æ ‚úÖ';
      downloadBtn.disabled=false;

      if (addInterpretations && Object.keys(interpretationMap).length===0) {
        alert('–ß–µ–∫–±–æ–∫—Å –≤–∫–ª—é—á—ë–Ω, –Ω–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í ¬´–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏¬ª –±—É–¥—É—Ç –ø—Ä–æ—á–µ—Ä–∫–∏.');
      }
    });

    downloadBtn.addEventListener('click',()=>{
      if(workbookOut) XLSX.writeFile(workbookOut,'processed.xlsx');
    });
  </script>
</body>
</html>

